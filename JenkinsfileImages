pipeline {
    agent any

    environment {
        VENV_PATH = "${WORKSPACE}/venv"
        PYTHON = 'python3'
        HUGGINGFACE_HUB_TOKEN = credentials('huggingface-token-id')
    }

    stages {
        // Etapa 0: Selecció del model
        stage('Model Selection') {
            steps {
                sh "echo 'Model: ${env.MODELS}'"
            }
        } 

        // Etapa 1: Clonar el codi del repositori
        stage('Checkout Code') {
            steps {
                git url: 'https://github.com/guillemhs/uoc-llm-security-framework.git', branch: 'main'
            }
        } 

        // Etapa 2: Configurar l'entorn virtual Python
        stage('Setup Python Environment') {
            steps {
                sh '${PYTHON} -m venv venv'
                sh '. venv/bin/activate && pip install --upgrade pip'
                sh '. venv/bin/activate && pip install -r requirements.txt'
                sh '. venv/bin/activate && pip install huggingface_hub[cli]'
            }
        }

        // Etapa 3: Descarregar el model de HuggingFace
        stage('Download HuggingFace Model') {
            steps {
                sh """ source ./venv/bin/activate && hf auth login --token $HUGGINGFACE_HUB_TOKEN """ 
                sh """ export HUGGINGFACE_HUB_TOKEN=$HUGGINGFACE_HUB_TOKEN """
                sh """ echo 'Descarregar el model de HuggingFace ${env.MODELS}' """
                sh """ . venv/bin/activate && ${PYTHON} setup/download_text_to_image_model.py ${env.MODELS} """
            } 
        }

        // Etapa 4: Execució de les proves de scripts
        stage('Script Check') {
            steps {
                sh """ echo 'Execució de la prova de Garak a ${env.MODELS}' """
                sh """. venv/bin/activate && ${PYTHON} audit_images/probes.py ${env.MODELS} >> logs_${env.MODELS}.txt """
            }
        }

        
        // Etapa 5: Agregar resultats
        stage('Aggregate Results') {
            steps {
                sh """. venv/bin/activate && ${PYTHON} utils/aggregate_results.py ${env.MODELS} """
            }
        }

        // Etapa 6: Arxivar resultats
        stage('Archive Results') {
            steps {
                archiveArtifacts artifacts: 'results/*.txt', allowEmptyArchive: true
            }
        }

        // Post-execució: enviar notificacions o netejar recursos
        post {
            success {
                echo """Pipeline per ${env.MODELS} completat amb èxit  """
            }
            failure {
                echo 'El pipeline ha fallat. Revisa els logs per trobar el problema.'
            }
        }
    }
}