pipeline {
    agent any

    // Definim el paràmetre MODELS perquè l'usuari el pugui introduir
    parameters {
        string(name: 'MODELS', defaultValue: 'compvis/stable-diffusion-v1-4', description: 'El ID del model de HuggingFace a provar')
    }

    environment {
        PYTHON = 'python3'
        // Assignem la credencial a la variable estàndard que moltes eines de HF busquen automàticament
        HF_TOKEN = credentials('huggingface-token-id')
    }

    stages {
        // Etapa 0: Informació
        stage('Model Selection') {
            steps {
                echo "Model seleccionat: ${params.MODELS}"
            }
        } 

        // Etapa 1: Clonar el codi
        stage('Checkout Code') {
            steps {
                git url: 'https://github.com/guillemhs/uoc-llm-security-framework.git', branch: 'main'
            }
        } 

        // Etapa 2: Configurar l'entorn virtual Python
        stage('Setup Python Environment') {
            steps {
                // Executem tot en un sol bloc per eficiència
                sh """
                    ${PYTHON} -m venv venv
                    . venv/bin/activate && pip install --upgrade pip
                    . venv/bin/activate && pip install -r requirements.txt
                    . venv/bin/activate && pip install "huggingface_hub[cli]"
                """
            }
        }

        // Etapa 3: Descarregar el model de HuggingFace
        stage('Download HuggingFace Model') {
            steps {
                // Passem el token com a variable d'entorn explícita per a aquest script
                // El login manual sovint no cal si la variable d'entorn està setejada, 
                // però ho deixem per seguretat amb --token
                sh """
                    source ./venv/bin/activate   && hf auth login --token  ${HF_TOKEN}
                    export HUGGINGFACE_HUB_TOKEN=${HF_TOKEN}
                    echo 'Descarregant el model: ${params.MODELS}'
                    ${PYTHON} setup/download_text_to_image_model.py "${params.MODELS}"
                """
            } 
        }

        // Etapa 4: Execució de les proves de scripts
        stage('Script Check') {
            steps {
                sh """
                    . venv/bin/activate && echo 'Execució de la prova de Garak a ${params.MODELS}'
                    . venv/bin/activate && ${PYTHON} audit_images/probes.py "${params.MODELS}" >> "logs_${params.MODELS.replaceAll('/','_')}.txt"
                """
            }
        }
        
        // Etapa 5: Agregar resultats
        stage('Aggregate Results') {
            steps {
                sh """
                    . venv/bin/activate && ${PYTHON} utils/aggregate_results.py "${params.MODELS}"
                """
            }
        }

        // Etapa 6: Arxivar resultats
        stage('Archive Results') {
            steps {
                // Arxivem tant la carpeta results com els logs generats a l'arrel
                archiveArtifacts artifacts: 'results/*.txt, logs_*.txt', allowEmptyArchive: true
            }
        }
    }

    // Post-execució
    post {
        success {
            echo "Pipeline per ${params.MODELS} completat amb èxit."
        }
        failure {
            echo 'El pipeline ha fallat. Revisa els logs de la consola.'
        }
        cleanup {
            // Opcional: Netejar l'espai de treball per estalviar espai
            cleanWs()
        }
    }
}