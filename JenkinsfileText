pipeline {
    agent any

    // 1. Definim els paràmetres d'entrada perquè no falli per variables buides
    parameters {
        string(name: 'MODELS', defaultValue: 'openai-community/gpt2', description: 'Model de HuggingFace a analitzar')
        string(name: 'PROBES', defaultValue: 'encoding', description: 'Tipus de probes per a Garak')
    }

    environment {
        PYTHON = 'python3'
        // Aquesta variable ja estarà disponible per a tots els sh steps
        HUGGINGFACE_HUB_TOKEN = credentials('huggingface-token-id')
    }

    stages {
        stage('Model Selection') {
            steps {
                // Utilitzem params.MODELS en lloc d'env.MODELS per claredat
                echo "Model seleccionat: ${params.MODELS}"
                echo "Probes seleccionades: ${params.PROBES}"
            }
        } 

        stage('Checkout Code') {
            steps {
                git url: 'https://github.com/guillemhs/uoc-llm-security-framework.git', branch: 'main'
            }
        } 

        stage('Setup Python Environment') {
            steps {
                // Agrupem en un sol sh per eficiència
                sh """
                    ${PYTHON} -m venv venv
                    . venv/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                    pip install "huggingface_hub[cli]"
                """
            }
        }

        stage('Download HuggingFace Model') {
            steps {
                // No cal fer export manual, la variable d'entorn ja hi és.
                // Fem el login i la descàrrega en el mateix bloc per assegurar l'entorn.
                sh """
                    source ./venv/bin/activate && hf auth login --token  ${HUGGINGFACE_HUB_TOKEN}
                    echo 'Descarregant el model: ${params.MODELS}'
                    ${PYTHON} setup/download_model.py "${params.MODELS}"
                """
            } 
        }

        stage('Garak Check') {
            steps {
                script {
                    // Sanititzem el nom del model per evitar errors amb la barra '/'
                    def safeModelName = params.MODELS.replaceAll('/', '_')
                    
                    sh """
                        . venv/bin/activate
                        echo 'Execució de Garak a ${params.MODELS} amb probes ${params.PROBES}'
                        chmod +x run_garak.sh
                        ./run_garak.sh "${params.MODELS}" "${params.PROBES}" | tee logs_${safeModelName}.txt
                    """
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline finalitzat. Processant resultats...'
            // Només intentem executar l'script si l'entorn virtual existeix
            script {
                if (fileExists('venv/bin/activate')) {
                    sh """. venv/bin/activate && ${PYTHON} utils/aggregate_results.py "${params.MODELS}" """
                }
            }
            // Arxivem resultats i logs
            archiveArtifacts artifacts: 'results/*.txt, logs_*.txt', allowEmptyArchive: true
        }
        success {
            echo "Pipeline per ${params.MODELS} completat amb èxit."
        }
        failure {
            echo 'El pipeline ha fallat.'
        }
    }
}